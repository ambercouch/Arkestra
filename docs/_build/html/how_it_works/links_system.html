

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>The links system &mdash; Arkestra dev documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/../../../arkestra.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     'dev',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="Arkestra dev documentation" href="../index.html" />
    <link rel="next" title="The video system" href="video_system.html" />
    <link rel="prev" title="The image sizing system" href="image_sizing_system.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="video_system.html" title="The video system"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="image_sizing_system.html" title="The image sizing system"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Arkestra dev documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="the-links-system">
<h1>The links system<a class="headerlink" href="#the-links-system" title="Permalink to this headline">¶</a></h1>
<p>The links system is one of the most complex parts of Arkestra.</p>
<div class="section" id="the-externallinks-database">
<h2>The ExternalLinks database<a class="headerlink" href="#the-externallinks-database" title="Permalink to this headline">¶</a></h2>
<div class="section" id="saving-an-externallink-in-admin">
<h3>Saving an ExternalLink in Admin<a class="headerlink" href="#saving-an-externallink-in-admin" title="Permalink to this headline">¶</a></h3>
<p><cite>ExternalLinkForm.clean()</cite> checks that the link is in order.</p>
<p>If the URL (which must be unique) already exists in the database, an error is
raised; if the title already exists, a warning is raised (a duplicate title
could be confusing but is not fatal).</p>
<p>When an object that can have an External URL is saved, the ModelAdmin.clean()
of that object must call <cite>links.admin.get_or_create_external_link()</cite>, passing
it various items of information:</p>
<ul class="simple">
<li>self.cleaned_data.get(&#8220;input_url&#8221;, None), # a manually entered url</li>
<li>self.cleaned_data.get(&#8220;external_url&#8221;, None), # a url chosen with autocomplete</li>
<li>self.cleaned_data.get(&#8220;title&#8221;), # link title</li>
<li>self.cleaned_data.get(&#8220;summary&#8221;), # link description</li>
</ul>
<p><cite>links.admin.get_or_create_external_link()</cite> checks that information against
the database:</p>
<ul class="simple">
<li>is the URL scheme of <cite>input_url</cite> or <cite>external_url</cite> permitted by
<cite>links.utils.check_urls()</cite>?</li>
<li>has an <cite>input_url</cite> been provided?<ul>
<li>get_or_create an <cite>ExternalLink</cite> based on it</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section" id="the-links-schema-system">
<h2>The links schema system<a class="headerlink" href="#the-links-schema-system" title="Permalink to this headline">¶</a></h2>
<p>Any model can be registered with the links system, making it easy to search for - using the admin autocomplete search - and link to published instances of the model.</p>
<p>The registry system works in a similar way to django.contrib.admin.</p>
<p>A <cite>link_schema.py</cite> module is required - see the one in <cite>contacts_and_people</cite> for an example.</p>
<p>Any object we&#8217;re going to link to needs a particular set of attributes. These can be built in to the model, or if they&#8217;re not, we need to write a wrapper around the model to provide them.</p>
<p>A list of the needed attributes is in <cite>links.schema_registry.ATTRIBUTES</cite>.</p>
<div class="section" id="the-very-simplest-case">
<h3>The very simplest case<a class="headerlink" href="#the-very-simplest-case" title="Permalink to this headline">¶</a></h3>
<p>The model has all the needed attributes already; even the admin has the <cite>search_fields</cite> declared:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># import the model</span>
<span class="kn">from</span> <span class="nn">news_and_events.models</span> <span class="kn">import</span> <span class="n">Event</span>

<span class="c"># import the admin class</span>
<span class="kn">from</span> <span class="nn">news_and_events.admin</span> <span class="kn">import</span> <span class="n">EventAdmin</span>

<span class="c"># register it</span>
<span class="n">schema</span><span class="o">.</span><span class="n">register</span><span class="p">(</span>
    <span class="n">models</span><span class="o">.</span><span class="n">Event</span><span class="p">,</span>
    <span class="n">search_fields</span><span class="o">=</span><span class="n">admin</span><span class="o">.</span><span class="n">EventAdmin</span><span class="o">.</span><span class="n">search_fields</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>This works because <cite>FormDefinition</cite> does indeed happen to have a (required) <cite>title</cite> attribute, though we won&#8217;t always be so lucky.</p>
<p>Now when we&#8217;re using any class that inherits from <cite>links.models.LinkMethodsMixin</cite>, we&#8217;ll be able to choose the type <cite>FormDefinition</cite>, and search through its instances for one to make a link to.</p>
</div>
<div class="section" id="nearly-as-simple">
<h3>Nearly as simple<a class="headerlink" href="#nearly-as-simple" title="Permalink to this headline">¶</a></h3>
<p>Perhaps the attributes are there, but we need to do a little more work to get hold of them:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">schema</span><span class="o">.</span><span class="n">register</span><span class="p">(</span>
    <span class="n">models</span><span class="o">.</span><span class="n">Event</span><span class="p">,</span>
    <span class="n">search_fields</span><span class="o">=</span><span class="n">admin</span><span class="o">.</span><span class="n">EventAdmin</span><span class="o">.</span><span class="n">search_fields</span><span class="p">,</span>
        <span class="c"># wrapper attributes</span>
        <span class="n">title</span><span class="o">=</span><span class="s">&#39;name&#39;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s">&#39;some_foreign_key.title&#39;</span><span class="p">,</span>
        <span class="n">heading</span><span class="o">=</span><span class="s">&#39;&quot;Event&quot;&#39;</span>
        <span class="p">)</span>
</pre></div>
</div>
<p>Each named argument after search_fields represents a attribute the wrapper will have.</p>
<p>We can use a dotted path to traverse through
object, starting from the linked object.</p>
<dl class="docutils">
<dt><cite>description=&#8217;some_foreign_key.title&#8217;</cite></dt>
<dd>use the object&#8217;s <cite>some_foreign_key.title</cite> for the description. Any
attribute - a callable or property - will do.</dd>
<dt><cite>heading=&#8216;&#8220;Event&#8221;&#8217;</cite></dt>
<dd>use a static string for the heading under which objects of this type will
be grouped in lists of links. Both <cite>&#8220;&#8216;foo&#8217;&#8221;</cite> and <cite>&#8216;&#8220;bar&#8221;&#8217;</cite> work.</dd>
</dl>
</div>
<div class="section" id="let-s-do-some-extra-calculation">
<h3>Let&#8217;s do some extra calculation<a class="headerlink" href="#let-s-do-some-extra-calculation" title="Permalink to this headline">¶</a></h3>
<p>This works by providing a callable that takes one argument: the linked object
It can be a lamda function or a external function:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">some_very_complicated_function</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">something</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">y</span><span class="p">:</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">u&quot;foo: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">x</span><span class="o">.</span><span class="n">bar</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">u&quot;stuff: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">x</span><span class="o">.</span><span class="n">bar</span><span class="p">)</span>
    <span class="k">return</span> <span class="s">&quot;&lt;br /&gt;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

<span class="n">schema</span><span class="o">.</span><span class="n">register</span><span class="p">(</span>
    <span class="n">models</span><span class="o">.</span><span class="n">Event</span><span class="p">,</span>
    <span class="n">search_fields</span><span class="o">=</span><span class="n">admin</span><span class="o">.</span><span class="n">EventAdmin</span><span class="o">.</span><span class="n">search_fields</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="k">lambda</span> <span class="n">obj</span><span class="p">:</span> <span class="s">u&quot;</span><span class="si">%s</span><span class="s"> (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">unicode</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span> <span class="n">obj</span><span class="o">.</span><span class="n">active_count</span><span class="p">),</span>
    <span class="n">description</span><span class="o">=</span><span class="n">some_very_complicated_function</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="create-our-own-linkwrapper-subclass">
<h3>Create our own <cite>LinkWrapper</cite> subclass<a class="headerlink" href="#create-our-own-linkwrapper-subclass" title="Permalink to this headline">¶</a></h3>
<p>We can also create a <cite>LinkWrapper</cite> and provide it with the required attributes. Some of these might do some complex work for us, but here&#8217;s a simple one first:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># import the model</span>
<span class="kn">from</span> <span class="nn">form_designer.models</span> <span class="kn">import</span> <span class="n">FormDefinition</span>

<span class="c"># declare a wrapper with a search field</span>
<span class="k">class</span> <span class="nc">FormDefinitionLinkWrapper</span><span class="p">(</span><span class="n">LinkWrapper</span><span class="p">):</span>
    <span class="n">search_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;title&#39;</span><span class="p">,]</span>

<span class="c"># register the wrapper</span>
<span class="n">schema</span><span class="o">.</span><span class="n">register_wrapper</span><span class="p">(</span><span class="n">FormDefinition</span><span class="p">,</span> <span class="n">FormDefinitionLinkWrapper</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">The links system</a><ul>
<li><a class="reference internal" href="#the-externallinks-database">The ExternalLinks database</a><ul>
<li><a class="reference internal" href="#saving-an-externallink-in-admin">Saving an ExternalLink in Admin</a></li>
</ul>
</li>
<li><a class="reference internal" href="#the-links-schema-system">The links schema system</a><ul>
<li><a class="reference internal" href="#the-very-simplest-case">The very simplest case</a></li>
<li><a class="reference internal" href="#nearly-as-simple">Nearly as simple</a></li>
<li><a class="reference internal" href="#let-s-do-some-extra-calculation">Let&#8217;s do some extra calculation</a></li>
<li><a class="reference internal" href="#create-our-own-linkwrapper-subclass">Create our own <cite>LinkWrapper</cite> subclass</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="image_sizing_system.html"
                        title="previous chapter">The image sizing system</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="video_system.html"
                        title="next chapter">The video system</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/how_it_works/links_system.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="video_system.html" title="The video system"
             >next</a> |</li>
        <li class="right" >
          <a href="image_sizing_system.html" title="The image sizing system"
             >previous</a> |</li>
        <li><a href="../index.html">Arkestra dev documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright Daniele Procida.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>